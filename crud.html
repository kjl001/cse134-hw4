<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta name="description" content="Custom Dialogs Page">
	<meta name="keywords" content="HTML">
	<meta name="author" content="Kevin Lee">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Kevin Lee's Personal Portfolio</title>
	<link href="images/favicon.ico" rel="icon">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.1/purify.min.js" integrity="sha512-TU4FJi5o+epsahLtM9OFRvH2gXmmlzGlysk9wtTFgbYbMvFzh3Cw1l3ubnYIvBiZCC/aurRHS408TeEbcuOoyQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
	<script type="module" src="scripts/blog.js"></script>
</head>

<body>
	<header>
		<h1>Summary of Blogs</h1>
	</header>

	<main>
		<section id="container">

		</section>
		<button id="add-blog" onclick="addDiag()">Add Blog</button>
	</main>

	<dialog id="diagBox">
		<form id="blog-form" method="dialog">
			<p class="diag-id" hidden></p>
			<!--Set Title for blog-->
			<label for="title-input">Title: </label>
			<input type="text" name="title-input" id="title-input"> <br>
			<!--Set Date for blog-->
			<label for="time-input">Date: </label>
			<input type="date" name="time-input" id="time-input"> <br>
			<!--Set Summary for blog-->
			<label for="summary-input">Summary: </label>
			<textarea name="summary-input" id="summary-input" form="blog-form" rows="4" cols="30"></textarea> <br>
			<!--Confirm or Cancel-->
			<button id="cancel" value="Cancel">Cancel</button>
			<button id="save" value="Save">Save</button>
		</form>
	</dialog>

	<template id="blog-template">
		<section id="blog">
			<!--Blog ID-->
			<p class="blog-id" hidden></p>
			<!--Post Title-->
			<h2 id="title"></h2>
			<!--Post Date-->
			<time id="time"></time> <br>
			<!--Post Summary-->
			<p id="summary"></p> <br>
			<!--Add Edit and Delete-->
			<button id="edit" onclick="editDiag(this.parentElement)">Edit</button>
			<button id="delete" onclick="this.parentElement.remove()">Delete</button>
		</section>
	</template>

	<script>
		/* Edit button */
		function editDiag(elem) {
			const diagBox = document.getElementById("diagBox");
			diagBox.querySelector("#blog-form").querySelector("#title-input").value = elem.querySelector("#title").innerHTML;
			diagBox.querySelector("#blog-form").querySelector("#time-input").value = elem.querySelector("#time").innerHTML;
			diagBox.querySelector("#blog-form").querySelector("#summary-input").value = elem.querySelector("#summary").innerHTML;

			diagBox.querySelector("#blog-form").querySelector("#save").value = "Edit";

			/* Set currIndex to be this index */
			diagBox.querySelector(".diag-id").id = elem.querySelector(".blog-id").id;

			diagBox.showModal();
		}

		/* Add Button */
		function addDiag() {
			const diagBox = document.getElementById("diagBox");
			diagBox.querySelector("#blog-form").querySelector("#save").value = "Save";
			diagBox.showModal();
		}
	</script>

	<script type="module">
		import { config } from './scripts/blog.js';
		import { storage } from './scripts/blog.js';

		const container = document.getElementById("container");
		const template = document.getElementById("blog-template");

		/* Default blog posts */
		container.appendChild(template.content.cloneNode(true));
		container.appendChild(template.content.cloneNode(true));
		container.appendChild(template.content.cloneNode(true));

		container.children[0].querySelector("#title").innerHTML = "Started on Homework 4!";
		container.children[0].querySelector("#time").innerHTML = "2023-02-23";
		container.children[0].querySelector("#summary").innerHTML = "Started on my Homework 4 assignment for CSE 134B. I also have other projects too, however.";
		container.children[0].querySelector(".blog-id").id = 0;

		var newBlog = {
			title: "Started on Homework 4!",
			time: "2023-02-23",
			summary: "Started on my Homework 4 assignment for CSE 134B. I also have other projects too, however.",
			index: 0
		};
		storage.push(newBlog);

		container.children[1].querySelector("#title").innerHTML = "Finished up a CSE 123 Project";
		container.children[1].querySelector("#time").innerHTML = "2023-02-27";
		container.children[1].querySelector("#summary").innerHTML = "Finally finished PA3 for the class. Had to visit office hours for some questions.";
		container.children[1].querySelector(".blog-id").id = 1;

		newBlog.title = "Finished up a CSE 123 Project";
		newBlog.time = "2023-02-27";
		newBlog.summary = "Finally finished PA3 for the class. Had to visit office hours for some questions.";
		newBlog.index = 1;
		storage.push(newBlog);

		container.children[2].querySelector("#title").innerHTML = "Finished Homework 4!";
		container.children[2].querySelector("#time").innerHTML = "2023-03-01";
		container.children[2].querySelector("#summary").innerHTML = "Finished up Homework 4 for CSE 134B. Updated portfolio website with javascript.";
		container.children[2].querySelector(".blog-id").id = 2;

		newBlog.title = "Finished Homework 4!";
		newBlog.time = "2023-03-01";
		newBlog.summary = "Finished up Homework 4 for CSE 134B. Updated portfolio website with javascript.";
		newBlog.index = 2;
		storage.push(newBlog);

		/* Set to local storage */
		localStorage.setItem("blogs", JSON.stringify(storage));

		const diagBox = document.getElementById("diagBox");

		diagBox.addEventListener("close", () => {
			/* When cancel or no input, just exit */
			if (diagBox.returnValue == "Cancel" || document.getElementById("title-input").value == "" || document.getElementById("time-input").value == "" || document.getElementById("summary-input").value == "") {
				document.getElementById("title-input").value = "";
				document.getElementById("time-input").value = "";
				document.getElementById("summary-input").value = "";
			}

			/* When saving, create new blog */
			else if (diagBox.returnValue == "Save") {
				/* Fill template with dialog input */
				const addTemp = document.getElementById("blog-template");
				addTemp.content.querySelector("#blog").querySelector("#title").innerHTML = DOMPurify.sanitize(document.getElementById("title-input").value);
				addTemp.content.querySelector("#blog").querySelector("#time").innerHTML = DOMPurify.sanitize(document.getElementById("time-input").value);
				addTemp.content.querySelector("#blog").querySelector("#summary").innerHTML = DOMPurify.sanitize(document.getElementById("summary-input").value);
				addTemp.content.querySelector("#blog").querySelector(".blog-id").id = config.index;
				config.index++;

				/* Add to storage array */
				const blogObj = {
					title: addTemp.content.querySelector("#blog").querySelector("#title").innerHTML,
					time: addTemp.content.querySelector("#blog").querySelector("#time").innerHTML,
					summary: addTemp.content.querySelector("#blog").querySelector("#summary").innerHTML,
					index: addTemp.content.querySelector("#blog").querySelector(".blog-id").id
				};
				storage.push(blogObj);

				/* Set to local storage */
				localStorage.setItem("blogs", JSON.stringify(storage));

				/* Empty dialog */
				document.getElementById("title-input").value = "";
				document.getElementById("time-input").value = "";
				document.getElementById("summary-input").value = "";

				container.appendChild(addTemp.content.cloneNode(true));
			}

			// How do I figure out which template to edit?
			// Set ID for each? Set counter in global. Have each new creation refer to ID holding.
			// Loop through array and find ID to match
			/* Editing current blog */
			else {
				const currIndex = diagBox.querySelector(".diag-id").id;
				const editBlog = document.getElementById(currIndex).parentElement;
				editBlog.querySelector("#title").innerHTML = DOMPurify.sanitize(document.getElementById("title-input").value);
				editBlog.querySelector("#time").innerHTML = DOMPurify.sanitize(document.getElementById("time-input").value);
				editBlog.querySelector("#summary").innerHTML = DOMPurify.sanitize(document.getElementById("summary-input").value);

				/* Find index of element to edit */
				for (let i = 0; i < storage.length; i++) {
					if (storage[i].index == currIndex) {
						storage[i].title = editBlog.querySelector("#title").innerHTML;
						storage[i].time = editBlog.querySelector("#time").innerHTML;
						storage[i].summary = editBlog.querySelector("#summary").innerHTML;
					}
				}

				localStorage.setItem("blogs", JSON.stringify(storage));

				document.getElementById("title-input").value = "";
				document.getElementById("time-input").value = "";
				document.getElementById("summary-input").value = "";
			}
		});
	</script>
</body>

</html>